[{"content":" é€™æ˜¯ What Is New in MySQL 8.4 since MySQL 8.0 çš„ç³»åˆ—æ–‡ï¼Œ\næœƒé‡å°éƒ¨åˆ†æˆ‘è¦ºå¾—è·Ÿæ—¥å¸¸ç¶­é‹æœ‰é—œçš„æ›´å‹•ç‰¹åˆ¥ç ”ç©¶ï¼Œ\nå…¶é¤˜çš„å°±ç•¶æ•…äº‹æ›¸ï¼Œçœ‹éçŸ¥é“å³å¯ Introduction #Scalar correlated subqueries to derived tables.\nMySQL 8.4.0 lifts a previous restriction on transforming a correlated scalar subquery to a derived table such that an operand of the equality expression which did not contain an outer reference could be a simple column reference only.\nThis means that inner columns can be contained in deterministic expressions, as shown here:\nfunc1(.., funcN(.., inner-column-a, ..), inner-column-b) = outside-expression inner-column-a + inner-column-b = outside-expression For example, the following query is now supported for optimization:\nSELECT * FROM t1 WHERE ( SELECT func(t2.a) FROM t2 WHERE func(t2.a) = t1.a ) \u0026gt; 0; The inner operand cannot contain outer column references; likewise, the outer operand cannot contain inner column references. In addition, the inner operand cannot contain a subquery.\nIf the transformed subquery has explicit grouping, functional dependency analysis may be excessively pessimistic, resulting in an error such as ERROR 1055 (42000): Expression #2 of SELECT list is not in GROUP BY clause and contains nonaggregated column ....\nFor the InnoDB storage engine, the transform is disabled by default (that is, the subquery_to_derived flag of the optimizer_switch variable is not enabled); in this case, such queries pass without raising any errors, but are also not transformed.\nSee Section 15.2.15.7, â€œCorrelated Subqueriesâ€, for more information.\nä»¥ä¸Šå¼•ç”¨è‡³å®˜æ–¹åŸæ–‡\nSummary #å…ˆè¬›çµè«–ï¼Œé è¨­ subquery_to_derived é€™ optimizer_switch æ˜¯ é—œé–‰ çš„ï¼Œ\næˆ‘å€‘ä¹Ÿæ²’æœ‰ç‰¹åˆ¥èª¿æ•´éè¨­å®šæª”å…¬ç‰ˆï¼Œæ‰€ä»¥å½±éŸ¿æ²’æœ‰å¾ˆå¤§ï¼Œ\nçŸ¥é“æœ‰é€™åŠŸèƒ½ï¼Œæ—¥å¾Œæœ‰éœ€è¦æ™‚ï¼Œå†çœ‹çœ‹æœ‰æ²’æœ‰åˆé©å³å¯ã€‚\né è¨­æ˜¯é—œé–‰çš„åŸå› æ˜¯ï¼Œ\nåœ¨å¤§å¤šæƒ…æ³ä¸‹ï¼Œé–‹å•Ÿè©²åƒæ•¸ä¸¦æ²’æœ‰é¡¯è‘—çš„æ•ˆèƒ½æ”¹å–„ ( ç”šè‡³æœƒæœ‰æ›´æ…¢çš„ç¾è±¡ )\né€™å¥è©±æ˜¯å®˜æ–¹æ–‡æª”å¯«çš„ï¼Œä¸æ˜¯é€ è¬  ğŸ¤—\nåŸæ–‡ : The default value for this flag is off, since, in most cases, enabling this optimization does not produce any noticeable improvement in performance (and in many cases can even make queries run more slowly)\né€™åŠŸèƒ½æœ€æ—©æ˜¯åœ¨ 8.0.21 æ–°å¢çš„ï¼Œ8.4 åªæ˜¯å°è©²åŠŸèƒ½å¢åŠ æ›´å¤šæ”¯æ´ï¼Œ\nç•¶ correlated subqueries æ˜¯ deterministic funtions æ™‚ï¼Œ\nå°±å¯ä»¥è¢« subquery_to_derived é€²è¡Œæ”¹å¯«å„ªåŒ–\nè«‹åƒè€ƒä»¥ä¸‹å·®ç•°\nMySQL 8.4 #SHOW CREATE TABLE t1 \\G *************************** 1. row *************************** Table: t1 Create Table: CREATE TABLE `t1` ( `a` int NOT NULL, PRIMARY KEY (`a`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utfTE TABLE t2 \\G *************************** 1. row *************************** Table: t2 Create Table: CREATE TABLE `t2` ( `a` int NOT NULL, PRIMARY KEY (`a`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /* subquery_to_derived é è¨­ç‚º OFF */ SELECT @@optimizer_switch like \u0026#39;%subquery_to_derived=OFF%\u0026#39; AS \u0026#39;subquery_to_derived=OFF\u0026#39; ; +-------------------------+ | subquery_to_derived=OFF | +-------------------------+ | 1 | +-------------------------+ 1 row in set (0.0008 sec) EXPLAIN SELECT * FROM t1 WHERE ( SELECT COUNT(t2.a) FROM t2 WHERE CAST(t2.a AS BINARY) = t1.a ) \u0026gt; 0 ; +----+--------------------+-------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+--------------------+-------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------+ | 1 | PRIMARY | t1 | NULL | index | NULL | PRIMARY | 4 | NULL | 1 | 100 | Using where; Using index | | 2 | DEPENDENT SUBQUERY | t2 | NULL | index | NULL | PRIMARY | 4 | NULL | 1 | 100 | Using where; Using index | +----+--------------------+-------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------+ 2 rows in set, 2 warnings (0.0008 sec) SET SESSION optimizer_switch = \u0026#39;subquery_to_derived=on\u0026#39; ; /* subquery_to_derived æ”¹æˆ ON */ SELECT @@optimizer_switch like \u0026#39;%subquery_to_derived=ON%\u0026#39; AS \u0026#39;subquery_to_derived=ON\u0026#39; ; +------------------------+ | subquery_to_derived=ON | +------------------------+ | 1 | +------------------------+ 1 row in set (0.0003 sec) EXPLAIN SELECT * FROM t1 WHERE ( SELECT COUNT(t2.a) FROM t2 WHERE CAST(t2.a AS BINARY) = t1.a ) \u0026gt; 0 ; +----+-------------+------------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+------------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------------------------+ | 1 | PRIMARY | t1 | NULL | index | NULL | PRIMARY | 4 | NULL | 1 | 100 | Using index | | 1 | PRIMARY | \u0026lt;derived2\u0026gt; | NULL | ALL | NULL | NULL | NULL | NULL | 2 | 100 | Using where; Using join buffer (hash join) | | 2 | DERIVED | t2 | NULL | index | PRIMARY | PRIMARY | 4 | NULL | 1 | 100 | Using index; Using temporary | +----+-------------+------------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------------------------+ 3 rows in set, 2 warnings (0.0014 sec) MySQL 8.0 #SHOW CREATE TABLE t1 \\G *************************** 1. row *************************** Table: t1 Create Table: CREATE TABLE `t1` ( `a` int NOT NULL, PRIMARY KEY (`a`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utfTE TABLE t2 \\G *************************** 1. row *************************** Table: t2 Create Table: CREATE TABLE `t2` ( `a` int NOT NULL, PRIMARY KEY (`a`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /* subquery_to_derived é è¨­ç‚º OFF */ SELECT @@optimizer_switch like \u0026#39;%subquery_to_derived=OFF%\u0026#39; AS \u0026#39;subquery_to_derived=OFF\u0026#39; ; +-------------------------+ | subquery_to_derived=OFF | +-------------------------+ | 1 | +-------------------------+ 1 row in set (0.0007 sec) EXPLAIN SELECT * FROM t1 WHERE ( SELECT COUNT(t2.a) FROM t2 WHERE CAST(t2.a AS BINARY) = t1.a ) \u0026gt; 0 ; +----+--------------------+-------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+--------------------+-------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------+ | 1 | PRIMARY | t1 | NULL | index | NULL | PRIMARY | 4 | NULL | 1 | 100 | Using where; Using index | | 2 | DEPENDENT SUBQUERY | t2 | NULL | index | NULL | PRIMARY | 4 | NULL | 1 | 100 | Using where; Using index | +----+--------------------+-------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------+ 2 rows in set, 2 warnings (0.0016 sec) SET SESSION optimizer_switch = \u0026#39;subquery_to_derived=on\u0026#39; ; /* subquery_to_derived æ”¹æˆ ON */ SELECT @@optimizer_switch like \u0026#39;%subquery_to_derived=ON%\u0026#39; AS \u0026#39;subquery_to_derived=ON\u0026#39; ; +------------------------+ | subquery_to_derived=ON | +------------------------+ | 1 | +------------------------+ 1 row in set (0.0008 sec) EXPLAIN SELECT * FROM t1 WHERE ( SELECT COUNT(t2.a) FROM t2 WHERE CAST(t2.a AS BINARY) = t1.a ) \u0026gt; 0 ; +----+--------------------+-------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+--------------------+-------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------+ | 1 | PRIMARY | t1 | NULL | index | NULL | PRIMARY | 4 | NULL | 1 | 100 | Using where; Using index | | 2 | DEPENDENT SUBQUERY | t2 | NULL | index | NULL | PRIMARY | 4 | NULL | 1 | 100 | Using where; Using index | +----+--------------------+-------+------------+-------+---------------+---------+---------+------+------+----------+--------------------------+ 2 rows in set, 2 warnings (0.0010 sec) ä¸»è¦é—œæ³¨æ–¼æœ€å¾Œ EXPLAIN çš„çµæœ\nåœ¨ MySQL 8.4ï¼Œé–‹å•Ÿ subquery_to_derived=ON æ™‚ï¼Œ\nåªè¦ correlated subqueries çš„ functions æ˜¯ deterministicï¼Œ\nå°±å¯ä»¥è¢«æ”¹å¯«æˆ derived table çš„èªæ³•é€²è¡ŒæŸ¥è©¢ã€‚\nåœ¨ MySQL 8.0 æ™‚ï¼Œåªæœ‰æ”¯æ´ simple column references\nType Example Deterministic Functions SUBSTR(),CONCAT(),CAST()... Nondeterministic Functions RAND(),NOW(),UUID()... Afterword #é€™ç¯‡å†ç ”ç©¶å¾Œå°±é»˜é»˜åœ°æŠŠå®ƒç§»é™¤ â­ çš„æ¨™è¨˜äº† ğŸ˜‚\nä¸€é–‹å§‹æ˜¯å› ç‚ºçœ‹åˆ°é€™è·Ÿ optimizer_switch æœ‰é—œï¼Œ\næ‰€ä»¥æ‰å°‡å…¶æ¨™è¨˜ç‚º â­ï¼Œ\næ·±å…¥ç ”ç©¶å¾Œç™¼ç¾é€™ç•°å‹•ä¼¼ä¹æ²’ä»€éº¼å¤ªå¤§çš„å½±éŸ¿ï¼Œ\nç•¢ç«Ÿå®˜æ–¹æ–‡æª”éƒ½èªªäº†ï¼Œé è¨­ç‚º é—œé–‰ çš„åŸå› æ˜¯å› ç‚ºå°æ–¼å¤§å¤šæ•¸æ‡‰ç”¨ä¾†èªªï¼Œ\né€™æ”¹è®Šä¸¦æ²’æœ‰å¸¶ä¾†é¡¯è‘—çš„æ”¹å–„ã€‚\né€™æ™‚åè€Œè®“æˆ‘å¥½å¥‡ç‚ºä»€éº¼æœ‰é€™æ”¹å‹•ï¼Œäº‹æƒ…çš„æºé ­æ˜¯ä»€éº¼ ? æ¥è‘—å°±å»ç¿»äº† WorkLogï¼Œ\nOpen Source çš„å¥½è™•å°±æ˜¯å…¨éƒ¨çš„ç•°å‹•ç´€éŒ„éƒ½å¯ä»¥åœ¨ Git ä¸Šæ‰¾åˆ°ï¼Œ\nè€Œä¸”é€™ç¨®æœ‰è¦æ¨¡çš„ Open Source Project éƒ½æœƒæœ‰è©³ç´°çš„èªªæ˜ä»¥åŠç´€éŒ„ã€‚\nMySQL 8.0 ä¸€é–‹å§‹æ–°å¢çš„ commit åœ¨ WL#13520ï¼Œ\né‡é»åœ¨æ–¼å…¶ä¸­å¯«åˆ°çš„é€™å¥ : It is on by default for secondary engines like RAPID.\nåˆå¸¶ä¾†äº†å¦å¤–çš„å¥½å¥‡ï¼Œ\nä»€éº¼æ˜¯ Secondary Engines ?\nMySQL ä¸æ˜¯å°±åªå‰©ä¸‹ InnoDB Engines è€Œå·²å— ? ( NDB é™¤å¤– )\næŸ¥äº†ä¸€ä¸‹ç™¼ç¾ï¼Œ\nåŸä¾†é€™å…¨æ˜¯ç‚ºäº† Oracle MySQL Enterprise åœ¨é‹ªè·¯å‘€ ğŸ˜ˆ\nä¸ç®¡æ˜¯ Secondary Engines é‚„æ˜¯ RAPIDï¼Œ\né€™éƒ½è·Ÿ MySQL HeatWave æœ‰é—œï¼Œ\nMySQL 8.4 é€™æ¬¡çš„ç•°å‹• commit åœ¨ WL#15540ï¼Œ\nå…¶ä¸­çš„é€™å¥ : This transformation is needed by Heatwave/RAPID, which doesn't support subqueries in the WHERE clause. ä¹Ÿå¯ä»¥ç™¼ç¾ï¼Œ\né€™ç•°å‹•éƒ½æ˜¯ç‚ºäº† MySQL HeatWave åšçš„æ”¹å–„ï¼Œ\né€™ä¸‹ç–‘æƒ‘éƒ½è§£é–‹äº†ï¼Œ\nç›®å‰å…¬å¸ä¸»è¦æ˜¯ä½¿ç”¨ Percona MySQLï¼Œ\nçŸ­æ™‚é–“å…§æ‡‰è©²æ˜¯æ²’è¾¦æ³•æ‘¸åˆ° MySQL HeatWave ä¾†ç©ç©äº†ï¼Œ\nåªèƒ½ç­‰åˆ°æ—¥å¾Œæœ‰æœä¸€æ—¥ï¼Œå†ä¾†çœ‹çœ‹é€™æ”¹å‹•å°æ–¼ MySQL HeatWave æœ‰ä»€éº¼æ”¹å–„å§\nReference # GitHub : mysql-server Commit 8fda114 GitHub : mysql-server Commit 0354e46 MySQL Documentation : 15.2.15.7 Corrlated Subqueries MySQL HeatWave Documentation : 4.2.6.2 Define the Secondary Engine ","date":"1 October 2025","permalink":"https://yangnianli.github.io/blog/scalar-correlated-subqueries-to-derived-tables/","section":"Blog","summary":"","title":"[MySQL 8.4] Scalar Correlated Subqueries to Derived Tables"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/categories/","section":"Categories","summary":"","title":"Categories"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/categories/databases/","section":"Categories","summary":"","title":"Databases"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/tags/mysql/","section":"Tags","summary":"","title":"Mysql"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/tags/mysql8.4/","section":"Tags","summary":"","title":"Mysql8.4"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/tags/","section":"Tags","summary":"","title":"Tags"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/","section":"Yang's Blog","summary":"","title":"Yang's Blog"},{"content":"Introduction #éœ€æ±‚æ˜¯å¸Œæœ› GCP ä¸Šä½¿ç”¨ GCE è‡ªæ¶çš„ MySQL æœå‹™å¯ä»¥åŒæ­¥è³‡æ–™è‡³ AWS RDSï¼Œ\næä¾›çµ¦éƒ¨ç½²æ–¼ AWS çš„æœå‹™å­˜å–ä½¿ç”¨ï¼Œåƒ…éœ€è¦ ReadOnlyï¼Œä¸éœ€è¦ Writeï¼Œ\né™¤äº†å¯ä»¥é™ä½ AWS çš„ç¨‹å¼ â†’ GCP çš„ç¶²è·¯å‚³è¼¸è²»ç”¨ä»¥åŠå»¶é²ï¼Œ\nä¹Ÿå¯ä»¥é”åˆ° DR çš„ä½œç”¨\né è¨ˆåšæ³•\nGCP çš„ MySQL æœå‹™ä½¿ç”¨ Percona XtraBackup ( PXB ) å‚™ä»½\nå‚³é€å‚™ä»½æª”è‡³ AWS S3\né‚„åŸè‡³ AWS RDS\nå»ºç½®å¤–ç¶² ( or Site-to-Site VPN ) åŒæ­¥ ( AWS â†’ GCP )\nåŸºæœ¬ä¸Šï¼Œé€™äº›åŠŸèƒ½ RDS éƒ½æœ‰æä¾›ï¼Œä¹Ÿæœ‰ç›¸å°æ‡‰çš„å®˜æ–¹æ–‡ä»¶ï¼Œ\næƒ³äº†ä¸€ä¸‹ï¼Œé›£åº¦ä¸å¤§ï¼Œå°±ç›´æ¥å‹•å·¥å§\np.s. é™¤äº†ä½¿ç”¨ MySQL Native Replication ä»¥å¤–ï¼Œ\né‚„æœ‰å¦å¤–ä¸€å€‹å‚™æ¡ˆ - AWS DMS\nä¹Ÿå¯ä»¥é”åˆ°ç›¸åŒçš„çµæœï¼Œåªæ˜¯åŒæ­¥è³‡æ–™çš„æ–¹å¼æ”¹æˆä½¿ç”¨ DMS å¯¦ç¾\nRestoring a backup into an Amazon RDS for MySQL DB instance # å»ºç½® GCP æ¸¬è©¦æ©Ÿ # å› ç‚ºæ¸¬è©¦éç¨‹æœƒéœ€è¦æ–°å¢ fw ç›¸é—œè¨­å®šï¼Œæ•…æ­¤æ¬¡æ¸¬è©¦æ˜¯ä½¿ç”¨æ¸¬è©¦å°ˆæ¡ˆè‡ªå»º VPCï¼Œ\næ­£å¼å•Ÿç”¨æ™‚æ˜¯ä½¿ç”¨ XPN æ¶æ§‹ï¼Œä½†åŸç†è·Ÿæ­¥é©Ÿæ˜¯ç›¸åŒçš„\nå»ºç½® VPC / Subnets #### VPC gcloud compute networks create ${VPC_NAME} \\ --project=${PROJECT_ID} \\ --subnet-mode=custom \\ --mtu=1460 \\ --bgp-routing-mode=regional \\ --bgp-best-path-selection-mode=legacy ### Subnets ( CIDR è‡ªå®šå³å¯ ) gcloud compute networks subnets create ${SUBNETS_NAME} \\ --project=${PROJECT_ID} \\ --range=${CIDR} \\ --stack-type=IPV4_ONLY \\ --network=${VPC_NAME} \\ --region=asia-east1 å»ºç½® FW #### Allow AWS RDS ( source-ranges å¾ AWS VPC -\u0026gt; NAT gateways æŸ¥çœ‹ ) gcloud compute firewall-rules create ${FW_NAME} \\ --project=${PROJECT_ID} \\ --direction=INGRESS \\ --priority=1000 \\ --network=${VPC_NAME} \\ --action=ALLOW \\ --rules=tcp:3306 \\ --source-ranges=18.138.94.177/32,52.77.51.245/32,18.138.128.251/32 å»ºç½® MySQL #é€™é‚Šæ˜¯ä½¿ç”¨å…§éƒ¨è‡ªç ”çš„å¹³å°å»ºç½®ï¼Œå°±ä¸å±•é–‹èªªæ˜äº†\nå»ºç½® External Load Balancer #æ–°å¢ External Load Balancer è·Ÿ Instance Groupsï¼Œæ²’æœ‰ä»€éº¼éœ€è¦ç‰¹åˆ¥ç•™æ„çš„\nä½¿ç”¨ PXB å‚™ä»½è‡³ AWS S3 #Install AWS CLI #curl \u0026#34;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\u0026#34; -o \u0026#34;awscliv2.zip\u0026#34; unzip awscliv2.zip sudo ./aws/install Configuration AWS CLI # å› ç‚º AWS æ¸¬è©¦ç’°å¢ƒçš„ Account æ˜¯æ¡ç”¨ SSO ç™»å…¥ï¼Œ\nä¹‹å‰ä½¿ç”¨éçš„ Access Key æ–¹æ¡ˆå·²ç¶“ç„¡æ³•ä½¿ç”¨å›‰\naws configure sso --use-device-code PXB å‚™ä»½è‡³ AWS S3 #### å°±å–®ç´”å‚™ä»½ï¼Œæ²’ç‰¹åˆ¥è¦èªªæ˜çš„ï¼Œè¨˜å¾—ä½¿ç”¨ xbstream xtrabackup --backup --user=${USERNAME} \\ --password \\ --stream=xbstream \u0026gt; yangtest.xbstream ### å‚³åˆ° s3 aws s3 cp yangtest.xbstream s3://aws_s3_bucket_name é‚„åŸè‡³ AWS RDS # å…¬å¸å…§éƒ¨ä½¿ç”¨çš„ Terraform RDS Modules æœ‰æ”¯æ´ Restore From S3 çš„ç›¸é—œé…ç½®ï¼Œ\nä½†æ˜¯å…¬å¸å…§éƒ¨ Modulesï¼Œç„¡æ³•åˆ†äº«è«‹è¦‹è«’ï¼Œæœ‰å•é¡Œå¯ä»¥è©¢å•å“¦\nä¸»è¦æ–°å¢\ns3_import_bucket_name = \u0026#34;aws_s3_bucket_name\u0026#34; s3_import_ingestion_role = \u0026#34;arn:aws:iam::xxxxxxxxxxxx:role/rds-restore-from-s3-role\u0026#34; å…¶é¤˜å°±è·Ÿä¸€èˆ¬ä½¿ç”¨ Terraform ä¾†éƒ¨ç½² RDS ä¸€æ¨£\ns3_import_bucket_name : è¦é‚„åŸçš„ s3 bucket åç¨± s3_import_ingestion_role : ä½¿ç”¨å“ªå€‹ Role ä¾†åŸ·è¡Œ Configuring external source replication # AWS RDS Documentation : Configuring, starting, and stopping binary log ( binlog ) replication\n### é€£åˆ° RDSï¼ŒåŸ·è¡Œä»¥ä¸‹ Stored Procedures CALL mysql.rds_set_external_master_with_auto_position ( host_name , host_port , replication_user_name , replication_user_password , ssl_encryption , delay ); ### æœ¬æ¬¡ç¯„ä¾‹ä½¿ç”¨çš„æŒ‡ä»¤ CALL mysql.rds_set_external_master_with_auto_position ( \u0026#39;35.221.236.11\u0026#39; , 3306 , \u0026#39;aws_rds_rep\u0026#39; , \u0026#39;YangTest@123\u0026#39; , 1 , 0 ); ### é–‹å§‹åŒæ­¥ CALL mysql.rds_start_replication; ### ç„¶å¾Œå°±æˆåŠŸäº† SHOW SLAVE STATUS \\G Slave_IO_Running: Yes Slave_SQL_Running: Yes p.s. å¦‚æœ PXB çš„ä¾†æºæ˜¯ Replica çš„è©±ï¼Œ\nå¯ä»¥ä¸ç”¨é‡æ–°è¨­å®š rds_set_external_master_with_auto_positionï¼Œ\nå› ç‚ºç›¸é—œè³‡æ–™å·²ç¶“å­˜æ”¾æ–¼ mysql.slave_master_info ä¸­ï¼Œ\nåªéœ€è¦åŸ·è¡Œ mysql.rds_start_replication å³å¯\nTroubleshooting #Q : [å…§éƒ¨è‡ªç ”å¹³å°] é¸ä¸åˆ°è‡ªå»ºçš„ Subnets #A : å› ç‚ºè¨­å®šæª”ä¸­æœ‰åƒæ•¸ä¾†æ±ºå®šå¹³å°å»ºç½®æ©Ÿå™¨æ‰€éœ€è¦ä½¿ç”¨åˆ°çš„ ç¶²è·¯å°ˆæ¡ˆï¼Œ\næœƒé€™æ¨£è¨­è¨ˆçš„åŸå› æ˜¯å› ç‚ºæˆ‘å€‘ç¶²è·¯ç’°å¢ƒå¤§å¤šæ˜¯ä½¿ç”¨ XPN æ¶æ§‹ï¼Œ\næ‰€ä»¥éœ€è¦å°‡ ç¶²è·¯å°ˆæ¡ˆ è¨­å®šç‚ºä¸åŒçš„ Project\nQ : [å…§éƒ¨è‡ªç ”å¹³å°] é‚„æ˜¯é¸ä¸åˆ°å‘€ #A : é¡ä¼¼å•é¡Œï¼Œå› ç‚ºè¨­å®šæª”ä¸­æœ‰è¨­å®š filter ä¾†éæ¿¾ Subnetsï¼Œ\nåŸå› æ˜¯å› ç‚ºæ—©æœŸ GCP å°ˆæ¡ˆä½¿ç”¨çš„ç¶²è·¯æ¶æ§‹æ˜¯ VPC ä¸åˆ†ç’°å¢ƒï¼Œ\nä¹Ÿå°±æ˜¯ prodã€staging ä»¥åŠ test ç­‰ç­‰éƒ½åœ¨åŒä¸€å€‹ VPC åº•ä¸‹ï¼Œ\nä½†åœ¨è‡ªç ”å¹³å°ä¸­éœ€è¦å€åˆ†ç’°å¢ƒï¼Œ\næ‰€ä»¥æ‰è—‰ç”± filter ä¾†éæ¿¾éœ€è¦çš„ Subnets\nQ : [IAP] failed to connect to backend #A : æˆ‘å€‘ç›®å‰é€£ç·šåˆ° GCE éƒ½æ˜¯è—‰ç”± IAP ä¾†å¯¦ç¾ï¼Œ\nå¯åƒè€ƒ GCP IAP Doc å»ºç½® FW å¾Œå°±å¯ä»¥é€£ç·šå›‰!\n### Allow IAP Access ( CIDR æ˜¯å›ºå®šçš„ ) gcloud compute firewall-rules create allow-iap-access \\ --project=${PROJECT_ID} \\ --direction=INGRESS \\ --priority=1000 \\ --network=${VPC_NAME} \\ --action=ALLOW \\ --rules=tcp:22 \\ --source-ranges=35.235.240.0/20 Q : [startup-script] æ²’æœ‰åŸ·è¡Œ #A : å› ç‚ºæ©Ÿå™¨ç„¡æ³•å°å¤–ï¼Œéœ€è¦è¨­å®š Cloud NAT\n### Create Cloud Router ( aws-test-router ) gcloud compute routers create aws-test-router \\ --project=${PROJECT_ID} \\ --region=asia-east1 \\ --network=${VPC_NAME} ### Create Cloud NAT gateway ( aws-test-nat ) gcloud compute routers nats create aws-test-nat \\ --project=${PROJECT_ID} \\ --router=aws-test-router \\ --region=asia-east1 \\ --nat-all-subnet-ip-ranges \\ --auto-allocate-nat-external-ips Q : [startup-script] ç›£æ§å®‰è£å¤±æ•— #A : é€™æ˜¯ä¸€é€£ä¸²çš„éŒ¯èª¤é€ æˆçš„çµæœï¼Œ\nRoot Cause æ˜¯å› ç‚ºå‘¼å«ä¸åˆ°å…§éƒ¨çš„ APIï¼Œ\næ‰€ä»¥æ²’è¾¦æ³•å–å¾— my.cnf çš„è¨­å®šï¼Œ\né€ æˆ my.cnf ä½¿ç”¨ MySQL é è¨­çš„è¨­å®šï¼Œ\nå°è‡´ startup-script åŸ·è¡Œä¿®æ”¹å¸³å¯†æ™‚æ²’è¾¦æ³•å–å¾—å¯†ç¢¼è€Œä¿®æ”¹å¤±æ•—ï¼Œ\næœ€çµ‚é€ æˆçš„çµæœå°±æ˜¯ç›£æ§æ²’è¾¦æ³•ç™»å…¥ï¼Œå‡ºç¾å®‰è£å¤±æ•—\nè§£æ±ºè¾¦æ³•ï¼Œæš«æ™‚å°‡ ä¸Šè¿° Cloud NAT ç”¢ç”Ÿçš„ IP æ–°å¢è‡³ API çš„ allow_list\næˆåŠŸå¾Œè¨˜å¾—åˆªé™¤ allow_list Q : [SSO] oauth callback error 127.0.0.1 # A : ä½¿ç”¨ aws configure sso æ™‚æœƒè·³ OAuth callback å¤±æ•—ï¼Œ\nè«‹åƒè€ƒ New SSO Implementation Broken When Used Across Multiple Machines Â· Issue #9228 Â· aws/aws-cliï¼Œ\nåŠ ä¸Š --use-device-code å³å¯\nQ : [AWS IAM] å„ç¨®æ¬Šé™éŒ¯èª¤ #A : æºè‡ªæ–¼å° AWS IAM ä¸ç†Ÿæ‚‰å°è‡´ï¼Œ\nåŸºæœ¬ä¸Šé€™åœ¨ AWS Doc ä¸­éƒ½æœ‰æåˆ° Creating an IAM role manually\nTrust Policy # å¯èƒ½æˆ‘æ²’æ…§æ ¹ï¼Œå®˜æ–¹æä¾›çš„ç¯„ä¾‹çœŸçš„å¾ˆç¯„ä¾‹ï¼Œ\né€™é‚Šçš„ Service è¦å¡«å…¥ rds.amazonaws.com\n{\u0026quot;Service\u0026quot;: \u0026quot;rds.amazonaws.com\u0026quot;}\nä»£è¡¨é€™å€‹ Role å¯ä»¥è®“ RDS Assume\nRole Permissions # å› ç‚ºé€™é‚Šæˆ‘æ²’æœ‰ Create inline policy çš„æ¬Šé™ï¼Œ\næ‰€ä»¥æˆ‘åªèƒ½å…ˆçµ¦ AWS managed çš„ Policyï¼Œ\nç‚ºäº†ç¬¦åˆéœ€æ±‚ï¼Œæˆ‘é€™é‚Šæ˜¯è³¦äºˆäº† AmazonS3ReadOnlyAccess æ¬Šé™\nä»£è¡¨é€™å€‹ Role æ“æœ‰ S3 ReadOnly çš„æ¬Šé™\niam:PassRole # åˆæ˜¯ä¸€å€‹æˆ‘æ²’æ…§æ ¹çš„ç¯„ä¾‹ï¼Œ\né€™æ˜¯è¦åŠ åœ¨ ä½¿ç”¨è€… çš„æ¬Šé™ï¼Œ\nä»¥æˆ‘å€‘ç›®å‰ AWS Account çš„è¦åŠƒä¾†èªªï¼Œ\nå­˜åœ¨ä¸€å€‹ Rolesï¼Œåç¨±ç‚º AWSReservedSSO_DatabaseAdministrator_xxxxxxï¼Œ\nè¦å°‡æ¬Šé™åŠ åˆ°è©² Roles ä¸Šï¼Œ\nä»£è¡¨ æ“æœ‰ PassRole S3Access é€™å€‹ Role çµ¦ Service çš„æ¬Šé™\né¡å¤–èªªæ˜ä¸€ä¸‹ç‚ºä»€éº¼ AWS æœƒè¨­è¨ˆ iam:PassRole çš„åŸå› ï¼Œ\nä¸»è¦æ˜¯å®‰å…¨ä¸Šçš„è€ƒé‡\nä»Šå¤©æœ‰ä¸€ä½ User å»ºäº†ä¸€å° EC2ï¼Œä¸¦è³¦äºˆ EC2 Instance Role çš„æ¬Šé™ï¼Œ\nä¸€åˆ‡éƒ½å¾ˆæ­£å¸¸ã€å¾ˆç¾å¥½ ğŸ¤—ğŸ¤—ğŸ¤—\næœ‰å€‹ Bad User å‡ºç¾äº†ï¼Œ\nä»–æ˜æ˜åªæœ‰ LimitedAccessPolicy çš„æ¬Šé™ï¼Œç†è«–ä¸Šæ¬Šé™è¼ƒä½ï¼Œ\nä½†å› ç‚ºå»ºäº†ä¸€å° EC2ï¼Œä¸¦è³¦äºˆ EC2 æœ‰è¼ƒé«˜æ¬Šé™çš„ AdministratorAccess Roleï¼Œ\né€™æ™‚ Bad User å°±å¯ä»¥è—‰ç”± SSH åˆ°è©²å° EC2 Instanceï¼Œ\nä½¿ç”¨è¼ƒé«˜æ¬Šé™çš„ Role å»å‘¼å« AWS çš„ APIsï¼Œ\næ¬Šé™å°±è¢«ç¹éå»äº†\nè§£æ±ºæ–¹æ¡ˆ iam:PassRole å‡ºç¾äº†!\nä¸»è¦æ˜¯ç”¨ä¾† é™åˆ¶ User å¯ä»¥æŠŠå“ªäº› Role è³¦äºˆ Service ä½¿ç”¨çš„æ¬Šé™\nä»¥ä¸Šä¾‹å­ä¾†èªªï¼Œæˆ‘å€‘å¯ä»¥æ–°å¢ Allow iam:PassRole LimitedAccess\n{ \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;iam:PassRole\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:::123456789012:role/LimitedAccess\u0026#34; } Bad User ä¾¿ä¸èƒ½è³¦äºˆ AdministratorAccess Role çš„æ¬Šé™çµ¦ EC2 Serviceï¼Œ\nåªèƒ½è³¦äºˆ LimitedAccess Roleï¼Œä¸€å¤©åˆå¹³å®‰çš„éå»äº†ï¼Œå¯å–œå¯è³€ ğŸ¤—ğŸ¤—ğŸ¤—\nSummary #åŸºæœ¬ä¸Šé€™å€‹ä»»å‹™æƒ³åƒèµ·ä¾†æ²’æœ‰ä»€éº¼å¤ªå¤§çš„å›°é›£ï¼Œ\nå¯¦éš›æŒ‰ç…§å®˜æ–¹ Documentation æ“ä½œä¹Ÿåªæœ‰å°‘å°‘çš„ 1-2 é ï¼Œ\nä½†å°±å¦‚åŒæœ¬ç¯‡æ–‡ç« çš„ç¾å¯¦è¡æ“Šï¼Œ\nTroubleshooting çš„ç¯‡å¹…å¤§æ¦‚æ¯”å¯¦éš›æ“ä½œå¤šäº†ä¸€å€ä»¥ä¸Šï¼Œ\né—œé—œé›£éï¼Œä½†å°±é—œé—œéå§\nææ‡¼ä¾†è‡ªç‚ºæœªçŸ¥\né‡åˆ°äº†ï¼Œå°±äº†è§£å®ƒ\näº†è§£äº†ï¼Œå°±ä¸å†å®³æ€• Reference # AWS RDS Documentation : Restoring a backup into an Amazon RDS for MySQL DB instance AWS RDS Documentation : Configuring binary log file position replication with an eternal source instance Rowan Udell : AWS IAM:PassRole explained ","date":"16 September 2025","permalink":"https://yangnianli.github.io/blog/restoring-a-backup-into-an-amazon-rds-for-mysql-db-instance-and-configuring-external-source-replication/","section":"Blog","summary":"","title":"[AWS] Restoring a backup into an Amazon RDS for MySQL DB instance and Configuring external source replication"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/categories/aws/","section":"Categories","summary":"","title":"Aws"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/blog/","section":"Blog","summary":"","title":"Blog"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/tags/rds/","section":"Tags","summary":"","title":"Rds"},{"content":"","date":null,"permalink":"https://yangnianli.github.io/tags/sre/","section":"Tags","summary":"","title":"Sre"},{"content":"About Me # Yang He lives in Taichung City with his SPOF (wife) and two replicas\n- v1.0 (boy) and v2.0 (girl), both in primary school. mysql\u0026gt; SELECT -\u0026gt; `Name` AS Name , -\u0026gt; `JobTitle` AS JobTitle , -\u0026gt; `Description` AS Description -\u0026gt; FROM whoami \\G *************************** 1. row *************************** Name: Yang JobTitle: Database Administrator (DBA) / Database Reliability Engineer (DBRE) Description: æ“æœ‰ 10+ å¹´ DBA ç¶“é©—ï¼Œ å°ˆç²¾ MySQLï¼Œç®¡ç† TB ç´šè³‡æ–™åº«ã€è¶…é 600 å°ã€ç´„ 100 åº§ Cluster ç¶“é©—ã€‚ å…·å‚™è»Ÿé«”é–‹ç™¼èƒ½åŠ›ï¼Œç†Ÿæ‚‰ On-Premises ä»¥åŠ Cloud ( GCPã€AWS ) ç®¡ç†èˆ‡ç¶­é‹ç¶“é©—ï¼Œ ä¸¦æ“…é•·ä½¿ç”¨ Terraform ( OpenTofu )ã€Terragrunt ç­‰ IaC å·¥å…·ä¾†ç°¡åŒ–èˆ‡çµ±ä¸€å»ºç½®æµç¨‹ã€‚ ç†±æ„›å­¸ç¿’æ–°çŸ¥è­˜ä¾†è§£æ±ºæ—¥å¸¸ç¶­é‹å•é¡Œï¼Œç¿’æ…£ä¸€ç›´è¿½å•è‡ªå·±å•é¡Œç›´åˆ°æ²’æœ‰ç–‘å•ç‚ºæ­¢ï¼› ä¹Ÿæ¨‚æ–¼åˆ†äº«ï¼Œå…§å¿ƒä¸€ç›´ç›¸ä¿¡è‘—ã€Œç•¶æˆ‘èƒ½å¤ æ•™å­¸ä»–äººæ™‚ï¼Œæ‰ç®—æ˜¯çœŸæ­£å­¸æœƒã€‚ã€ å¦‚æœæ‚¨ä¹ŸèªåŒï¼Œæˆ‘æƒ³æˆ‘å€‘å¯ä»¥å¤šèŠèŠ ğŸ˜‡ 1 row in set (0.0007 sec) Work Experience #","date":null,"permalink":"https://yangnianli.github.io/about/","section":"Yang's Blog","summary":"","title":""}]